---
title: 'Webtoon API 업데이트'
titleImage: 'https://user-images.githubusercontent.com/71566740/144698893-3177ecc1-ce90-49ae-8e98-4986f66bce7a.png'
description: 'Daum 웹툰의 개편으로 인한 API 업데이트'
date: '2021-11-17'
tags: [project]
---

2020년 말쯤 웹툰 통합 정보 사이트를 만들어 보자는 생각으로 Webtoon Hub라는 토이 프로젝트를 진행하면서 필요했던 웹툰 정보들을 뿌려주는 서버를 만들었다.

프로젝트를 완성하고 해당 API를 버려두긴 아까워 문서도 만들고 공개 호스팅으로 돌리면서 대학교 동기나 후배들에게 제공하고 있었는데 이번에 업데이트할 내용이 있어서 이렇게 글로 남겨본다.

### 💥 Daum 웹툰의 개편

2021년 8월 기존 Daum 웹툰이 Kakao 웹툰으로 개편되었는데 단순 명칭 변경이 아닌 실제 페이지에 많은 변화가 있었다.

이 때문에 기존에 만들어 두었던 API 사용이 불가능한 상황이라 해당 프로젝트를 업데이트해야 했다.

### 👉 Korea Webtoon API의 업데이트

기존 API는 정해진 시간마다 크롤링한 데이터를 가공해 Express로 JSON 형태의 데이터 뿌려주는 방식이었다.

각 플랫폼별로 크롤링 모듈을 따로 설계해 두어서 사실 해당 모듈만 수정하면 되는 작업이었지만 그동안 벼르고 있었던 NestJS를 써보자는 생각으로 오히려 Naver 웹툰 크롤러 모듈을 제외한 모든 코드를 다시 작성하게 되었다.

#### 업데이트한 부분은 다음과 같다.

- Express 기반에서 NestJS로 전환
- Daum 웹툰 크롤러를 Kakao 웹툰에 맞게 변경
- 데이터 구조 재정의
- Kakao 페이지 추가
- 검색 API 추가

## 웹툰 정보 수집

### Naver 웹툰

사실 이전에 크롤링 코드를 모듈화 해놓고 그 부분은 건들지 않아도 정상 작동해서 이번 업데이트에서는 결과 데이터 형식을 제외하고는 크게 수정한 부분이 없었다.

네이버 웹툰은 한 페이지에 있는 웹툰들은 모두 한 번에 표시되는 방식이었고 딱히 크롤링을 방지하기 위한 장치도 없었다.

덕분에 정석적인 방법으로 크롤링 가능했다.

다만 파싱 속도와 이미지 퀄리티 때문에 PC 페이지가 아닌 모바일 페이지를 대상으로 크롤링했다.

### Kakao 웹툰

Kakao 웹툰은 특이하게 Kakao 웹툰과 Kakao 페이지로 나뉘어 서비스되고 있다.

처음에는 Naver 웹툰의 크롤러처럼 사이트 자체를 크롤링해서 정보를 얻으려고 시도했지만 Kakao 웹툰은 초기에 모든 정보들을 가져와 웹에 뿌려주는 방식이 아닌 필요할 때 서버에 요청해 그때그때 필요한 데이터들을 가져와 뿌려주는 방식이라 성능이 좋지 못했다.

그 밖에도 여러 가지 문제점이 많았고 정말 많은 것을 시도했던 것 같다.

이 부분에 대해서는 아래 "🔥 발생했던 이슈"에 후술 하겠다.

사실 Kakao 웹툰으로 개편되기 이전 Daum 웹툰에서는 사이트에서 발생하는 요청들을 개발자 도구로 분석해보면 요청을 보내는 URL을 찾을 수 있었고 별다른 인증 없이 외부 클라이언트에서도 같은 데이터를 요청할 수 있었는데 당연히 이 부분이 막혔을 것이라 생각했지만 Kakao 웹툰에서도 요청 URL만 바뀌었을 뿐 여전히 가능했다.

이런 방법이 가능하다면 HTML 코드를 파싱 하는 단계를 건너뛰고 요청과 응답 자체도 웹 페이지 자체를 크롤링하는 보다 훨씬 빨랐으므로 Kakao 웹툰과 페이지 둘 다 위 방법으로 데이터를 수집했다.

### 🔥 발생했던 이슈

처음에 Kakao 웹툰의 웹 페이지 자체를 크롤링하면서 생겼던 문제들과 해결했던 방법들이다.

**일반적인 사용자 접근이 아니면 페이지 자체 접근 차단**

> puppeteer가 핸들링하는 chromium에 사용자 정보를 추가

**짧은 시간내에 여러번 요청을 보내면 사이트에서 해당 IP를 일시적으로 차단**

> 새로운 페이지를 여는 딜레이를 크게 잡음(크롤링 속도 느려짐)

**Kakao 웹툰 페이지의 각 element들의 속성이 불규칙하고 구조가 복잡함**

> 불규칙한 부분이나 구조가 복잡한 부분은 puppeteer로 직접 핸들링해서 크롤링하고 규칙적인 속성들만 우선적으로 크롤링 (크롤링 속도 느려짐)

**해외 IP 차단(Heroku = 미국 서버)**

> 프록시를 사용하여 데이터 수집 (속도 느려짐, 프록시 상태에 의존)

결국 전혀 다른 방법을 사용하게 되었지만 해당 부분을 해결하기 위한 코드는 따로 분리해 [kakao-webtoon-crawler repository](https://github.com/HyeokjaeLee/kakao-webtoon-crawler)에 저장해두었다.

## 마지막으로

이번에 Express 코드를 NestJS로 바꾸면서 확실히 구조가 잘 정리된다는 느낌을 받았다.

그리고 Express를 사용할 때보다 기본적으로 제공하고 있는 기능들이 많아서 초기 설정에 많은 시간을 들이지 않아도 된다는 점도 매우 편리했다.

앞으로도 NestJS를 사용한 프로젝트들을 많이 진행해볼 생각이다.

해당 API의 코드는 [korea-webtoon-api repository](https://github.com/HyeokjaeLee/korea-webtoon-api)에 공개되어있다.
